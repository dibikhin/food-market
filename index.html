<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0' name='viewport' />
    <title>
        Фудмаркет
    </title>
    <!--Bootstrap-->
    <link href=
    "https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.4/css/bootstrap.min.css" rel=
    "stylesheet"><!--Bootstrap Tokenfield-->
    <link href=
    "https://cdnjs.cloudflare.com/ajax/libs/bootstrap-tokenfield/0.12.0/css/bootstrap-tokenfield.min.css"
    rel="stylesheet"><!--Tokenfield Typeahead-->
    <link href=
    "https://cdnjs.cloudflare.com/ajax/libs/bootstrap-tokenfield/0.12.0/css/tokenfield-typeahead.min.css"
    rel="stylesheet"><!--JQueryUI CSS-->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.css" rel=
    "stylesheet">
    
    <style>
        body { padding-top: 5px; } /*for top fixed navbar*/
    </style>
    
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        
        if (window.location.hostname === 'foodmarket.ml') {
            ga('create', 'UA-65760713-1', 'auto'); ga('send', 'pageview');
        }
    </script>

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
  <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>

<!-- Header menu -->
<nav class="navbar navbar-default navbar-fixed-top">
    <div class="container">
        <div class="row">
            <div class="col-md-6 col-md-offset-3">
                <h4 style="margin-top: 15px;">
                    ФудМаркет
                </h4>
                <span class="pull-right" style="margin-top: -35px;">
                        <a id="show-to-buy-list-btn" class="btn btn-default btn-sm show-to-buy-list-tab" href="#to-buy-list-tab" aria-controls="to-buy-list-tab" role="tab" data-toggle="tab">
                            <span class="glyphicon glyphicon-list"></span>
                                &nbsp;Список
                        </a>
                        <a id="show-login-tab-btn" class="btn btn-default btn-sm" href="#login-tab" aria-controls="login-tab" role="tab" data-toggle="tab">
                            <span class="glyphicon glyphicon-log-in"></span>
                                &nbsp;Вход
                        </a>
                        <a id="logout-btn" class="btn btn-default btn-sm" href="#main-tab" aria-controls="main-tab" role="tab" data-toggle="tab">
                            <span class="glyphicon glyphicon-log-out"></span>
                                &nbsp;Выйти
                        </a>
                    </span>
            </div>
        </div><!--row-->
    </div><!--container-->
</nav> <!-- Header menu -->
<!--style="margin-top: 60px;"-->
<div class="container">
<div class="row">
    <div class="col-md-6 col-md-offset-3">
        <div class="tab-content" id="tabs">
        
            <!-- Login Tab -->
            <div role="tabpanel" class="tab-pane" id="login-tab" style="margin-top: 40px;">
                <div class="row">
                    <div class="col-md-6">
                        <h3>Вход</h3>
                        <form id="login-form">
                            <div class="form-group">
                                <label for="email">Имейл</label>
                                <input type="email" class="form-control" id="email" required>
                            </div>
                            <div class="form-group">
                                <label for="password">Пароль</label>
                                <input type="password" class="form-control" id="password" required>
                            </div>
                            <button id="login-btn" type="submit" class="btn btn-default btn-sm">
                                <span class="glyphicon glyphicon-log-in" aria-hidden="true"></span>
                                    &nbsp;Войти
                            </button>
                        </form>
                    </div>    
                </div>
                
                <iframe frameborder="0" allowtransparency="true" scrolling="no" 
                    src="https://money.yandex.ru/embed/shop.xml?account=410013377738581&quickpay=shop&payment-type-choice=on&writer=seller&targets=%D0%94%D0%BE%D1%81%D1%82%D1%83%D0%BF+%D0%BA+%D0%A4%D1%83%D0%B4%D0%BC%D0%B0%D1%80%D0%BA%D0%B5%D1%82%D1%83+%D0%BD%D0%B0+1+%D0%B3%D0%BE%D0%B4.&targets-hint=&default-sum=49&button-text=01&mail=on&successURL=foodmarket.ml"
                    width="450" height="198" style="margin-left: -30px; margin-top: 15px;"></iframe>
                
                <!-- todo refactor show-search-food-btn -->
                
                <nav class="navbar navbar-default navbar-fixed-bottom">
                    <div class="container">
                        <div class="row">
                            <div class="col-md-6 col-md-offset-3">
                                <a class="btn btn-default btn-sm show-search-food-btn" href="#main-tab" aria-controls="main-tab" role="tab" data-toggle="tab"
                                    style="margin-top: 8px;">
                                    <span class="glyphicon glyphicon-search"></span>
                                    &nbsp;Поиск
                                </a>
                            </div>
                        </div>    
                    </div>
                </nav>
            </div>
            
            <!-- Main Tab -->
            <div role="tabpanel" class="tab-pane active" id="main-tab" style="margin-top: 60px;">
                <form>
                    <div class="form-group">
                        <input class="form-control" id="food-search" placeholder=
                        "Какие продукты есть?" type="text">
                        <!--Что есть или что хотите съесть?-->
                    </div>
                </form>
                <p id="not-found-recipes">
                    Введите продукты, и здесь появятся блюда.
                </p>
                
                <div id="found-recipes">
                    <!-- recipe item template -->
                    <div class="recipe-item">
                        <h4 style="margin-top: 25px;">
                            <span class="recipe-name"></span>
                            <span class="label label-default pull-right recipe-time">
                                &nbsp;мин.
                            </span>
                        </h4>
                        
                        <p style="margin-top: 10px;">
                            <strong>Не хватает</strong>
                            <span class="recipe-absent"></span>
                        </p>
                        
                        <!--<a class="btn btn-default btn-sm add-to-list-btn show-to-buy-list-tab" href="#to-buy-list-tab" aria-controls="to-buy-list-tab" role="tab" data-toggle="tab">-->
                        <!--    <span class="recipe-ix hidden"></span>-->
                        <!--    <span class="glyphicon glyphicon-plus"></span>-->
                        <!--    &nbsp;Добавить-->
                        <!--</a>-->
                        
                        <a class="btn btn-default btn-sm recipe-btn" href="#recipe-tab" aria-controls="recipe-tab" role="tab" data-toggle="tab">
                            <span class="recipe-ix hidden"></span>
                            <span class="glyphicon glyphicon-eye-open"></span>
                            &nbsp;Рецепт
                        </a>
                                    
                        <a class="btn btn-default btn-sm show-more-dishes-btn" href="#main-tab" aria-controls="main-tab" role="tab" data-toggle="tab">
                            <span class="recipe-ix hidden"></span>
                            <span class="glyphicon glyphicon-list"></span>
                            <span class="recipe-type">&nbsp;Еще&nbsp;</span>
                        </a>
                    </div> <!--recipe item template-->
                </div> <!--found-recipes-->

            </div> <!--main-tab-->
            
            <!-- Chosen Recipe Tab -->
            <div role="tabpanel" class="tab-pane" id="recipe-tab" style="margin-top: 60px; padding-bottom: 100px;">
                <div id="recipe-content">
                    <h4>
                        <span class="recipe-name"></span>
                        <span class="label label-default recipe-time" style="float: right;">
                            &nbsp;мин.
                        </span>
                    </h4>
                    
                    <p class="recipe-steps"></p>
                    
                    <p class="recipe-qtys"></p>
                    

                    <p style="margin-top: 10px;">
                        <strong>Не хватает&nbsp;</strong>
                        <span class="recipe-absent"></span>
                    </p>
                    
                    <nav class="navbar navbar-default navbar-fixed-bottom" style="margin-bottom: 50px;">
                        <div class="container">
                            <div class="row">
                                <div class="col-md-6 col-md-offset-3">
                                    
                                    <a class="btn btn-default btn-sm add-to-list-btn show-to-buy-list-tab" href="#to-buy-list-tab" aria-controls="to-buy-list-tab" role="tab" data-toggle="tab"
                                    style="margin-top: 9px;">
                                        <span class="recipe-ix hidden"></span>
                                        <span class="glyphicon glyphicon-plus"></span>
                                        &nbsp;Добавить в список
                                    </a>
                                    
                                    <a class="btn btn-default btn-sm show-more-dishes-btn" href="#" aria-controls="" role="tab" data-toggle="tab"
                                    style="margin-top: 9px; margin-left: 5px;">
                                        <span class="recipe-ix hidden"></span>
                                        <span class="glyphicon glyphicon-list"></span>
                                        <span class="recipe-type">&nbsp;Еще&nbsp;</span>
                                    </a>
                                </div>
                            </div>    
                        </div>
                    </nav>
                </div> <!-- recipe-content -->
                
                <nav class="navbar navbar-default navbar-fixed-bottom">
                    <div class="container">
                        <div class="row">
                            <div class="col-md-6 col-md-offset-3">
                                <a class="btn btn-default btn-sm show-search-food-btnch-food-btn" href="#main-tab" aria-controls="main-tab" role="tab" data-toggle="tab"
                                    style="margin-top: 10px;">
                                    <span class="glyphicon glyphicon-search"></span>
                                    &nbsp;Поиск
                                </a>
                            </div>
                        </div>    
                    </div>
                </nav>
                
                <!-- Back Nav -->
                <!--<a class="btn btn-default btn-sm" href="#main-tab" aria-controls="main-tab" role="tab" data-toggle="tab"-->
                <!--    style="margin-top: 10px;">-->
                <!--    <span class="glyphicon glyphicon-arrow-left"></span>-->
                <!--    &nbsp;Назад-->
                <!--</a>-->
            </div> <!-- recipe-tab -->
            
            <!--To Buy Tab-->
            <div role="tabpanel" class="tab-pane" id="to-buy-list-tab" style="margin-top: 60px;">
                <div id="to-buy-list">
                    <h3>
                        Список продуктов
                    </h3>
                    
                    <form class="form-inline">
                        <div class="form-group">
                            <input id="to-userlogin" type="email" class="form-control" placeholder="Логин в Фудмаркете" required
                            style="width: 160px; display: inline-block;">
                            <button id="send-to-user-btn" type="button" class="btn btn-default btn-sm">
                                <span class="glyphicon glyphicon-send" aria-hidden="true"></span>
                                    &nbsp;Отправить
                            </button>
                        </div>
                    </form>
                    
                    <!--to-buy-search-->
                    <!-- todo rename 'addToList*' -->
                    <form class="form-inline" style="margin-top: 10px;">
                        <div class="form-group">
                            <input id="to-buy-search" type="text" class="form-control" placeholder="Что купить?" required
                            style="width: 160px; display: inline-block;">
                            <button type="button" class="btn btn-default btn-sm addToList">
                                <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
                                    &nbsp;Добавить
                            </button>
                        </div>
                    </form>
                    
                    <p id="about-to-buy-saving" style="margin-top: 10px;">
                        Список сохраняется только после входа.
                    </p>
                    
                    <div id="to-buy-food-list"></div>
                    
                    <nav class="navbar navbar-default navbar-fixed-bottom">
                        <div class="container">
                            <div class="row">
                                <div class="col-md-6 col-md-offset-3">
                                    <a class="btn btn-default btn-sm show-search-food-btn" href="#main-tab" aria-controls="main-tab" role="tab" data-toggle="tab"
                                        style="margin-top: 10px;">
                                        <span class="glyphicon glyphicon-search"></span>
                                        &nbsp;Поиск
                                    </a>
                                </div>
                            </div>    
                        </div>
                    </nav>
                </div>
                
                <!--<a class="btn btn-default btn-sm" href="#main-tab" aria-controls="main-tab" role="tab" data-toggle="tab"-->
                <!--    style="margin-top: 10px;">-->
                <!--    <span class="glyphicon glyphicon-arrow-left"></span>-->
                <!--    &nbsp;Назад-->
                <!--</a>-->
            </div> <!--to-buy-list-tab-->
        </div> <!--tab-content-->
    </div> <!--col-->
</div> <!--row-->

</div>  <!--container-->


<!--jQuery-->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
<!--jQueryUI-->
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
<!--Firebase-->
<script src="https://cdn.firebase.com/js/client/2.2.7/firebase.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-tokenfield/0.12.0/bootstrap-tokenfield.min.js"></script>
<!--Underscore-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
<!--FastClick-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js"></script>

<!--PureJS--> 
<!--Yandex.Browser claims security issue-->
<!--<script src="https://raw.github.com/pure/pure/master/libs/pure.js"></script>-->
<script src="pure.min.js"></script>

<script>

$(document).ready(function() {
    
    //// curing lagging clicks at iPhones
    window.addEventListener(
        'load',
        function() { new FastClick(document.body); },
        false);
    
    
    //// helpers
    var capitalizeFirstLetter = function(str) {
        return str.charAt(0).toUpperCase() + str.substring(1);
    };
    
    
    //// views, visual effects
    
    $(document).on('click', '#show-to-buy-list-btn', function() {
        $(this).blur();
    });
    
    $(document).on('click', '#show-login-tab-btn', function() {
        $(this).blur();
    });
    
    
    ////// less unstructured:)
    
    //// logic

    var fillRecipesWithAbsents = function(fromRecipes, toRecipes) {
        _.each(fromRecipes, function(recipe_val, recipe_id) { // value, key
        	var dif = _.difference(recipe_val.foodIndex, chosenFood()); // note the order
            if ( _.size(dif) < _.size(recipe_val.foodIndex) ) {
                recipe_val.ix = recipe_id;
                recipe_val.absent = dif.join(' ');
                toRecipes[recipe_id] = recipe_val;
            }
        });
    };
    
    //// data sync
    var linkToBuyFoodList = function(_authData) {
        firebase.child('cooks').child(_authData.uid).child('to_buy_food_list')
            .on(
                'value', 
                function(cooksToBuyFoodList) {
                    toBuyFoodList = cooksToBuyFoodList.val();
                    $('#to-buy-food-list').html('');
                    _.each(toBuyFoodList, function(toBuyFood) {
                        appendToList(toBuyFood);
                    })
                });
    };
    
    var unLinkToBuyFoodList = function(_authData) {
        firebase.child('cooks').child(_authData.uid).child('to_buy_food_list').off();
    };

    var authData = null;
    
    var firebase = new Firebase("https://foodmarket.firebaseio.com/");
    
    
    //// auto login
    authData = firebase.getAuth();
    if(authData) {
        linkToBuyFoodList(authData);
        firebase.child('cooks').child(authData.uid)
            .update({ 'last_seen_at': Firebase.ServerValue.TIMESTAMP });
        $('#show-login-tab-btn').hide();
        $('#about-to-buy-saving').hide();
    } else {
        $('#logout-btn').hide();
    }
    
    
    //// init autocompletes
    firebase.child('food').once('value', function(snapshot) {
        $('#food-search').tokenfield({
            delimiter: [',', ' '],
            autocomplete: {
                source: snapshot.val(), // it's not live
                delay: 100,
                minLength: 2
            }
        });
        
        $('#to-buy-search').autocomplete({
            source: snapshot.val(), // it's not live too
        });        
    });
    
    //// template engine
    var recipeItemDirective = {
        '.recipe-item': {
            'recipe<-': {
                '.recipe-ix': 'recipe.ix',
                '.recipe-name': 'recipe.name',
                '+.recipe-time': 'recipe.time', // note '+'
                '.recipe-absent': 'recipe.absent',
                '.recipe-type+': 'recipe.type.toLowerCase' // note '+' here too text-lowercase
            }
        }
    };
    
    var recipeDirective = {
        '.recipe-ix': 'ix',
        '.recipe-name': 'name',
        '+.recipe-time': 'time', // note '+' here
        '.recipe-absent': 'absent',
        '.recipe-steps': 'steps',
        '.recipe-qtys': 'qtys',
        '.recipe-type+': 'type.toLowerCase', // note '+' here too text-lowercase
    };
    
    // compile is of PureJS
    var compiledRecipeItemDirective = $('#found-recipes').compile(recipeItemDirective);
    var compiledRecipeDirective = $('#recipe-content').compile(recipeDirective);
    
    //// cosmetics
    $('#found-recipes').hide();
    
    var chosenFood = function() {
        var delimiter = ',';
        var chosenFoodStr = $('#food-search').tokenfield('getTokensList', delimiter, false /* beautify */);
        if (chosenFoodStr !== '') {
            return chosenFoodStr.split(delimiter);
        } else { 
            return null;
        }
    };
    
    //// food-search logic
    
    var recipes = null;
    var foundRecipes = null;
    
    var findFood = function() {
        
        $('#not-found-recipes').show();
        $('#found-recipes').hide();
        
        
        
        // todo: rename to *Map
        foundRecipes = {}; // todo: dangerous lifecycle
        
        // todo: pull up
        firebase.child('recipes').once('value', function(snapshot) {
            recipes = snapshot.val();
            
            fillRecipesWithAbsents(recipes, foundRecipes);
            
            if( !_.isEmpty(foundRecipes)) {
                var foundRecipesVals =_.values(foundRecipes);
                var firstThreeQuickestRecipes = [];
                
                var grps = _.groupBy(foundRecipesVals, function(rcpVal) { return rcpVal.type; });
                var grVals = _.values(grps);
                _.each(grVals, function(grVal) {
                    var sortedGr = _.sortBy(grVal, function(grRcpVal) { return grRcpVal.time; });
                    firstThreeQuickestRecipes.push(_.first(sortedGr));
                });
                
                var sortPriorities = {
                    "Салаты": 0,
                    "Супы": 1,
                    "Горячие": 2
                };
                
                firstThreeQuickestRecipes = _.sortBy(firstThreeQuickestRecipes, function(rcp) { return sortPriorities[rcp.type];});
                
                $('#found-recipes').render(firstThreeQuickestRecipes, compiledRecipeItemDirective);
                $('#not-found-recipes').hide();
                $('#found-recipes').show();
            }
        });
    };
    
    var mainLoop = function() {
        // todo: hide on keydown too
        $('.food-search').autocomplete('close');
        findFood();
    };
    
    //// Main loop, tokenfield events
    $('#food-search').on('tokenfield:createdtoken', mainLoop); // note 'd' in createdtoken
    // $('#food-search').on('tokenfield:editedtoken', findFood); // blinks
    $('#food-search').on('tokenfield:removedtoken', mainLoop);
    $('#food-search').on('tokenfield:createtoken', function (e) {
        // filter dups
        var existingTokens = $(this).tokenfield('getTokens');
        // todo: underscore it!
        $.each(existingTokens, function(index, token) {
            if (token.value.toLowerCase() === e.attrs.value.toLowerCase()) {
                e.preventDefault();
            }
        });
        
        // normalize food name
        var lowerValue = e.attrs.value.toLowerCase();
        e.attrs.value = capitalizeFirstLetter(lowerValue);
        e.attrs.label = capitalizeFirstLetter(lowerValue);
    });
    
    
    //// recipe content view
    $(document).on('click', '.recipe-btn', function() {
        var recipeIx = $(this).find('.recipe-ix').text();
        var curRecipe = foundRecipes[recipeIx];
        
        // todo reformat recipe.steps to ul/li
        
        $('#recipe-content').render(curRecipe, compiledRecipeDirective);
        $('#recipe-content').show();
    });
    
    var appendToList = function(itemToAdd) {
        $('#to-buy-food-list').append(
            '<div class="checkbox"><label><input type="checkbox" value="'
            + itemToAdd + '">'+ itemToAdd 
            + '</label>'
            + '<button type="button" class="close remove-list-item" aria-label="Close"><span aria-hidden="true">&times;</span></button>'
            + '</div>');
    };
    
    $(document).on('click', '.remove-list-item', function() {
        // todo: too fancy: Removes chbox, then sets list in FBZ, then redraws all chboxes
        $(this).closest('.checkbox').remove();
        var newToBuyFoodList = _.map($(':checkbox'), function(chbox) { return chbox.value; });
        
        var refillToBuyFoodList = function() {
            _.each(newToBuyFoodList, function(toBuyFood) {
                firebase.child('cooks').child(authData.uid).child('to_buy_food_list').push(toBuyFood);
            });
        };
        
        if(authData) {
            firebase.child('cooks').child(authData.uid).child('to_buy_food_list').remove(refillToBuyFoodList);
        }
    });
    
    
    //// recipe view
    
    $(document).on('click', '.show-more-dishes-btn', function() {
        if( !authData) {
            alert('После оплаты будет доступно больше блюд.');
            $(this).blur();
            return;
        }

        var recipeIx = $(this).find('.recipe-ix').text();
        var curRecipe = foundRecipes[recipeIx];

        var recipesVals = _.values(recipes);
        var recipesOfType = _.where(recipesVals, { type: curRecipe.type });
        var recipesOfTypeWithAbsents = {}; // =map
        
        fillRecipesWithAbsents(recipesOfType, recipesOfTypeWithAbsents);
        
        var recipesOfTypeWithAbsentsVals = _.values(recipesOfTypeWithAbsents);
        var sortedRecipesOfType = _.sortBy(recipesOfTypeWithAbsentsVals, function(rcpT) { return rcpT.time; });
        var sortedRecipesOfTypeWoCurrentDish = _.reject(
            sortedRecipesOfType, 
            function(rcpT) { return rcpT.name === curRecipe.name; });
        var threeTypedQuickestRecipes = _.first(sortedRecipesOfTypeWoCurrentDish, 3);
        
        foundRecipes = recipesOfTypeWithAbsents; // todo: too long, contains all of the type
        
        // todo: commenting leads to "index.html:580 Uncaught TypeError: Cannot read property 'type' of undefined"
        $('a[href="#main-tab"]').tab('show');
        
        $('#found-recipes').render(threeTypedQuickestRecipes, compiledRecipeItemDirective);
    });
    
    // add food from recipe
    $(document).on('click', '.add-to-list-btn', function() {
        var recipeIx = $(this).find('.recipe-ix').text();
        var curRecipe = foundRecipes[recipeIx];
        
        var difr = _.difference(curRecipe.foodIndex, chosenFood());
        _.each(difr, function(absentFood) {
            if(authData) {
                firebase.child('cooks').child(authData.uid).child('to_buy_food_list').push(absentFood);
            } else {
                appendToList(absentFood);
            }
        });
    });
    
    
    //// to-buy-food-list
    var toBuyFoodList = []; // todo: replace this cache w/ instant FBZ query
    
    var addToList = function() {
        var itemToAdd = $('#to-buy-search').val().trim();
        if(itemToAdd) {
            if(authData) {
                firebase.child('cooks').child(authData.uid).child('to_buy_food_list').push(itemToAdd);
            } else {
                appendToList(itemToAdd);
            }
        }
        $('#to-buy-search').val('').focus();
    };
    
    // todo join & convert to submit
    $(document).on('click', '.addToList', addToList);
    $('#to-buy-search').keypress(function(e) {
        if (e.which == 13) {
            addToList();
            e.preventDefault(); 
            return false;
        }
    });
    
    
    //// send to another cook
    
    var sendToUser = function() {
        if( !authData) {
            alert('Отправлять список можно после оплаты.');
            $('#send-to-user-btn').blur();
            return;
        }
        
        var toUserLogin = $('#to-userlogin').val();
        // it's 'select top 1 from cooks where cooks.email == toUserLogin
        firebase.child('cooks').orderByChild('email').equalTo(toUserLogin).once(
            'value',
            function(cookSnap) {
                var cookUid = _.keys(cookSnap.val())[0];
                _.each(toBuyFoodList, function(toBuyFood) {
                    firebase.child('cooks').child(cookUid).child('to_buy_food_list').push(toBuyFood);
                });
            });
        $('#send-to-user-btn').blur();
    };
    
    // todo join & convert to submit too
    // todo: form doesn't validate, fire it
    $(document).on('click', '#send-to-user-btn', sendToUser);
    $(document).on('keypress', '#to-userlogin', function(e) {
        if (e.which == 13) {
            sendToUser();
            e.preventDefault();
            return false;
        }
    });
    
    
    //// login/logout visibility
    
    $("#login-form").submit(function(e) {
        firebase.authWithPassword({
            email    : $('#email').val(),
            password : $('#password').val()
        }, function(error, inAuthData) {
            if (error) {
                alert("Не удалось войти :( " + error);
            } else {
                authData = inAuthData; // todo: possible leak?
                linkToBuyFoodList(authData);
                
                firebase.child('cooks').child(authData.uid)
                    .update({ 'last_seen_at': Firebase.ServerValue.TIMESTAMP });
                
                $('#logout-btn').show();
                $('#show-login-tab-btn').hide();
                $('a[href="#main-tab"]').tab('show');
                $('#email').val('');
                $('#password').val('');
                $('#about-to-buy-saving').hide();
            }
        });
        
        e.preventDefault();
    });
    
    $(document).on('click', '#logout-btn', function() {
        firebase.unauth();
        
        toBuyFoodList = []; // todo: due to its' global state
        
        unLinkToBuyFoodList(authData);
        
        authData = null;
        
        $('#to-userlogin').val('');
        
        $('#logout-btn').hide();
        $('#show-login-tab-btn').show();
        $('#about-to-buy-saving').show();
    });
    
    
    //// fill DB
    var _recipesList = [
        {
            name: 'Салат со сметаной и яйцом',
            time: 15,
            qtys: 'На&nbsp;300&nbsp;г зеленого салата&nbsp;&mdash; 1&nbsp;свежий огурец, 1&nbsp;яйцо, 1/2 стакана соуса из&nbsp;сметаны с&nbsp;уксусом.',
            foodIndex: ['Салат', 'Огурцы', 'Яйца', 'Сметана', 'Уксус'],
            steps: 'Обмытый и&nbsp;отсушенный зеленый салат нарезать и&nbsp;сложить в&nbsp;миску. Яйца, сваренные вкрутую, нарезать тонкими ломтиками и&nbsp;смешать с&nbsp;соусом из&nbsp;сметаны с&nbsp;уксусом. Перед самой подачей к&nbsp;столу заправить салат сметанным соусом с&nbsp;яйцом, уложить в&nbsp;салатник, обложить кружочками свежих огурцов и&nbsp;посыпать мелко нарезанным укропом или зеленью петрушки. Подается салат ко&nbsp;всем мясным и&nbsp;рыбным блюдам.',
            type: 'Салаты'
        },
        {
            name: 'Салат из свежих помидоров и огурцов',
            time: 5,
            qtys: 'На&nbsp;5&ndash;6 помидоров&nbsp;&mdash; 2&ndash;3&nbsp;огурца, 2&nbsp;ст. ложки растительного масла',
            foodIndex: ['Помидоры', 'Огурцы', 'Растительное масло', 'Репчатый лук', 'Зеленый лук'],
            steps: 'Вымытые помидоры и&nbsp;свежие огурцы нарезать тонкими кружочками, посыпать солью и&nbsp;перцем и&nbsp;красиво уложить в&nbsp;салатник. К&nbsp;моменту подачи на&nbsp;стол полить растительным маслом, сверху посыпать укропом или зеленью петрушки. Салат можно приготовить из&nbsp;одних огурцов или из&nbsp;одних помидоров. В&nbsp;этот салат по&nbsp;желанию добавляют репчатый лук, нарезанный тонкими кольцами, или мелко нарезанный зеленый лук. Подают салат к&nbsp;мясным и&nbsp;рыбным котлетам, к&nbsp;вареному или жареному мясу и&nbsp;рыбе, а&nbsp;также как отдельное блюдо.',
            type: 'Салаты'
        },
        {
            name: 'Салат из белокачанной капусты с яблоком и сельдереем',
            time: 10,
            qtys: 'На&nbsp;500&nbsp;г капусты белокочанной&nbsp;&mdash; 1&nbsp;стебель сельдерея (салатного или корневого), 1&nbsp;яблоко, 1/4 стакана уксуса, 1/2&nbsp;ст. ложки сахара.',
            foodIndex: ['Яблоки', 'Сельдерей', 'Капуста', 'Уксус', 'Сахар'],
            steps: 'Очищенные яблоки нарезать ломтиками, сельдерей нарезать соломкой длиной 4&ndash;5&nbsp;см; белокочанную капусту подготовить так&nbsp;же, как указано выше; все это перемешать, сложить в&nbsp;салатник, прибавить сахар и&nbsp;полить уксусом. Этот салат подают ко&nbsp;всем жареным и&nbsp;вареным мясным блюдам, к&nbsp;жареной и&nbsp;отварной рыбе, на&nbsp;гарнир к&nbsp;холодным мясным и&nbsp;рыбным блюдам, а&nbsp;также как самостоятельное блюдо.',
            type: 'Салаты'
        },
        {
            name: 'Салат из свежих овощей с яблоком',
            time: 20,
            qtys: 'На&nbsp;2&nbsp;свежих огурца&nbsp;&mdash; 2&nbsp;сырых моркови, 2&nbsp;яблока, 2&nbsp;помидора, 100&nbsp;г зеленого салата, 1/2 стакана сметаны, 1/4&nbsp;лимона.',
            foodIndex: ['Огурцы', 'Морковь', 'Яблоки', 'Помидоры', 'Салат', 'Сметана', 'Лимон'],
            steps: 'Обмытые свежие огурцы, сырую морковь и&nbsp;яблоки нарезать тонкой соломкой, а&nbsp;листики салата на&nbsp;3&ndash;4 части каждый. Все это перемешать и&nbsp;заправить сметаной, добавив лимонный сок, соль, сахар. Сверху салат украсить помидорами, нарезанными ломтиками. Такой салат, благодаря сырым овощам и&nbsp;фруктам, содержит значительное количество витаминов.',
            type: 'Салаты'
        },
        {
            name: 'Щи из свежей капусты',
            time: 110,
            qtys: 'На&nbsp;500&nbsp;г. мяса 500&nbsp;г. свежей капусты, 200&nbsp;г. моркови и&nbsp;лука, 2&nbsp;ст. ложки масла, 200&nbsp;г. помидоров.',
            foodIndex: ['Морковь', 'Репчатый лук', 'Капуста', 'Мясо', 'Картофель', 'Помидоры'],
            steps: 'Поставить варить мясной бульон. Через 1&nbsp1/2&nbsp;&mdash; 2&nbsp;часа после начала варки мясо вынуть, а&nbsp;бульон процедить в&nbsp;суповую кастрюлю, в&nbsp;которую положить предварительно поджаренную морковь и&nbsp;лук; затем положить мясо, добавить нарезанную капусту и&nbsp;варить в&nbsp;течение 30&ndash;40&nbsp;минут. За&nbsp;5-10 минут до&nbsp;окончания варки в&nbsp;щи&nbsp;добавить перец, лавровый лист, соль. Щи&nbsp;можно варить с&nbsp;добавлением картофеля и&nbsp;свежих помидоров. В&nbsp;этом случае очищенный и&nbsp;нарезанный картофель положить в&nbsp;кастрюлю через 10&ndash;15 минут после того, как положена капуста, а&nbsp;помидоры, нарезанные дольками,&nbsp;&mdash; в&nbsp;конце варки вместе с&nbsp;приправами.',
            type: 'Супы'
        },
        {
            name: 'Борщ летний',
            time: 45,
            qtys: 'На&nbsp;1-2 свеклы&nbsp;&mdash; 3&ndash;4&nbsp;шт. картофеля, 1&nbsp;шт. моркови, 1&nbsp;стебель сельдерея, 200&nbsp;г. кабачков, 1&ndash;2&nbsp;помидора, пучок зеленого лука.',
            foodIndex: ["Свекла", "Картофель", "Морковь", "Сельдерей", "Кабачки", "Помидоры", "Зеленый лук"],
            steps: 'Очищенную свеклу нарезать соломкой или ломтиками&nbsp;и, добавив морковь, положить в&nbsp;кастрюлю, залить кипящей водой (мясным или куриным бульоном) и&nbsp;варить в&nbsp;течение 10&ndash;15&nbsp;минут. После этого положить, очищенные кабачки, помидоры, картофель, зеленый лук, зелень сельдерея, соль, перец, гвоздику, лавровый лист и&nbsp;варить борщ до&nbsp;полной готовности ~25&nbsp;минут. При подаче к&nbsp;столу в&nbsp;борщ добавить сметану.',
            type: 'Супы'
        },
        {
            name: 'Солянка по-грузински',
            time: 60,
            qtys: 'На&nbsp;400&ndash;500&nbsp;г мяса (мякоти)&nbsp;&mdash; 2&nbsp;головки лука, 2&nbsp;соленых огурца, 2&nbsp;ст. ложки томата-пюре, 1/4 стакана виноградного вина и&nbsp;2&ndash;3&nbsp;ст. ложки масла.',
            foodIndex: ["Мясо", "Репчатый лук", "Томатная паста", "Соленые огурцы", "Вино", "Растительное масло"],
            steps: 'Мясо (филе) обмыть, зачистить от&nbsp;сухожилий, нарезать небольшими кусками, добавить мелко нарезанный репчатый лук и&nbsp;обжарить в&nbsp;масле на&nbsp;разогретой сковороде. Обжаренное мясо переложить в&nbsp;невысокую кастрюлю, добавить томатную пасту, очищенные и&nbsp;нарезанные ломтиками соленые огурцы, дольку чеснока, посолить, влить виноградное вино, 2&ndash;3&nbsp;ст. ложки мясного бульона&nbsp;и, покрыв кастрюлю крышкой, тушить в&nbsp;течение 30&ndash;40&nbsp;минут. Перед подачей к&nbsp;столу солянку посыпать зеленью петрушки.',
            type: 'Супы'
        },
        {
            name: 'Говядина тушеная с макаронами',
            time: 120,
            qtys: 'На&nbsp;500&nbsp;г мяса (мякоти)&nbsp;&mdash; 200&nbsp;г. макарон, 1&nbsp;ст. ложку томатной пасты, по&nbsp;1&nbsp;шт. моркови, лука и&nbsp;петрушки, 2&nbsp;ст. ложки подсолнечного масла.',
            foodIndex: ["Мясо", "Макароны", "Репчатый лук", "Морковь", "Петрушка", "Томатная паста"],
            steps: 'Мясо (мякоть) обмыть, посолить и&nbsp;целым куском положить на&nbsp;сковороду, затем обжарить со&nbsp;всех сторон до&nbsp;образования на&nbsp;мясе румяной корочки. Обжаренное мясо переложить в&nbsp;кастрюлю, добавить томатной пасты, 3&ndash;4 стакана бульона или горячей воды, очищенные, промытые морковь и&nbsp;лук, лавровый лист (2&ndash;3&nbsp;листика) и&nbsp;8-10 горошин перца (или 1/10&nbsp;шт. стручкового). Накрыть кастрюлю крышкой и&nbsp;поставить тушить на&nbsp;2&ndash;3&nbsp;часа. Примерно за&nbsp;30&ndash;40 минут до&nbsp;окончания тушения добавить столовую ложку подсолнечного масла. При подаче на&nbsp;стол мясо вынуть из&nbsp;соуса, нарезать ломтиками, уложить на&nbsp;блюдо; гарнировать макаронами, заправленными маслом; соус посолить, процедить сквозь сито и&nbsp;полить им&nbsp;мясо. На&nbsp;гарнир к&nbsp;тушеной говядине вместо макарон могут быть поданы жареный картофель, тушеная капуста.',
            type: 'Горячие'
        },
        {
            name: 'Баранина с зеленью и фасолью',
            time: 100,
            qtys: 'На&nbsp;500&nbsp;г баранины&nbsp;&mdash; 1&nbsp;стакан фасоли, 1&nbsp;головку лука, 200&nbsp;г. помидоров, 2&nbsp;ст. ложки масла.',
            foodIndex: ["Баранина", "Фасоль", "Репчатый лук", "Помидоры", "Зелень", "Растительное масло"],
            steps: 'Нарезанную небольшими кусками баранину посолить, посыпать перцем, обжарить на&nbsp;масле, переложить в&nbsp;неглубокую кастрюлю, добавить предварительно замоченную фасоль, 2 1/2&nbsp;&mdash; 3&nbsp;стакана воды и&nbsp;варить около часа. Затем добавить слегка поджаренный лук, нарезанные помидоры и&nbsp;тушить в&nbsp;течение 30&ndash;40&nbsp;минут. При подаче к&nbsp;столу посыпать зеленью петрушки.',
            type: 'Горячие'
        },
        {
            name: 'Суп с рыбными консервами',
            time: 40,
            qtys: 'На&nbsp;1&nbsp;банку рыбных консервов&nbsp;&mdash; 500&ndash;600&nbsp;г разных овощей, 1&ndash;1/2&nbsp;&mdash; 2&nbsp;л воды, 1&nbsp;ст. ложку масла.',
            foodIndex: ["Картофель", "Репчатый лук", "Морковь", "Капуста", "Рыбные консервы"],
            steps: 'Чистые овощи нарезать, залить водой и&nbsp;варить до&nbsp;готовности (~30&nbsp;минут). После этого положить рыбные консервы и&nbsp;дать супу закипеть, после закипания выключить.',
            type: 'Супы'
        },
        {
            name: 'Суп пюре из помидоров',
            time: 30,
            qtys: 'На&nbsp;750&nbsp;г помидоров&nbsp;&mdash; 4&nbsp;ст. ложки масла, 2&nbsp;ст. ложки муки, 4&nbsp;стакана молока, 1&nbsp;чайную ложку сахара, 2&nbsp;ст. ложки риса для гарнира.',
            foodIndex: ["Помидоры", "Молоко", "Мука", "Растительное масло", "Сахар", "Рис"],
            steps: 'Приготовить молочный соус. Для этого в&nbsp;суповой кастрюле слегка поджарить муку с&nbsp;2&nbsp;ст. ложками масла, развести ее&nbsp;горячим молоком и&nbsp;все это вскипятить. Свежие помидоры разрезать на&nbsp;части, добавить одну столовую ложку масла, сахар&nbsp;и, закрыв, тушить в&nbsp;течение 10&ndash;15&nbsp;минут. Затем влить 3&nbsp;стакана воды, вскипятить, смешать с&nbsp;молочным соусом и&nbsp;варить на&nbsp;слабом огне 15&ndash;20&nbsp;минут, после этого взбить блендером и&nbsp;заправить маслом. Перед подачей на&nbsp;стол в&nbsp;суп положить рис, сваренный отдельно.',
            type: 'Супы'
        },
        {
            name: 'Лапша',
            time: 85,
            qtys: 'На&nbsp;500&nbsp;г. мяса&nbsp;&mdash; 150&nbsp;г. лапши или вермишели, по&nbsp;1&nbsp;шт. моркови и&nbsp;лука, 2&nbsp;ст. ложки подсолнечного масла.',
            foodIndex: ["Мясо", "Лапша", "Репчатый лук", "Морковь", "Растительное масло"],
            steps: 'Сварить мясной или куриный бульон. Очищенные коренья и&nbsp;лук нашинковать в&nbsp;виде соломки, слегка поджарить с&nbsp;жиром, положить в&nbsp;процеженный бульон, довести его до&nbsp;кипения, после чего всыпать лапшу или вермишель, добавить лавровый лист, перец, соль и&nbsp;варить суп 15&ndash;20&nbsp;минут. Перед подачей к&nbsp;столу добавить укроп или зелень петрушки. Вместо лапши или вермишели в&nbsp;суп можно засыпать макароны, ушки, звездочки и&nbsp;т.&nbsp;п.',
            type: 'Супы'
        },
        {
            name: 'Крем суп из фасоли',
            time: 35,
            qtys: 'На&nbsp;1&nbsp;стакан фасоли&nbsp;&mdash; 2&ndash;3&nbsp;ст. ложки растительного масла, 1&nbsp;головку лука, 1&nbsp;морковь.',
            foodIndex: ["Фасоль", "Репчатый лук", "Морковь", "Растительное масло"],
            steps: 'Предварительно вымоченную фасоль отварить, смешать с&nbsp;поджаренным луком, добавить растительное масло, соль, перец, все хорошо измельчить блендером при необходимости добавить немного воды или мясного бульона, выложить на&nbsp;тарелку и&nbsp;охладить.',
            type: 'Супы'
        },
        {
            name: 'Салат с колбасой или ветчиной',
            time: 20,
            qtys: 'На&nbsp;200&nbsp;г. колбасы или ветчины&nbsp;&mdash; 3&ndash;4&nbsp;шт. картофеля, 50&nbsp;г. сельдерея, 75&nbsp;г. корнишонов (или маринованных огурцов), 1&nbsp;яблоко, 75&nbsp;г. салата, 1/3 стакана соуса майонез.',
            foodIndex: ["Колбаса", "Картофель", "Сельдерей", "Корнишоны", "Яблоки", "Майонез", "Салат"],
            steps: 'Нарезать зеленый салат. Колбасу или ветчину, картофель, сельдерей, яблоки и&nbsp;корнишоны нарезать ломтиками, сложить в&nbsp;миску. Соус майонез смешать с&nbsp;небольшим количеством горчицы, мелко нарезанной зеленью петрушки, прибавить уксус и&nbsp;посолить по&nbsp;вкусу. Заправить подготовленные продукты соусом, уложить в&nbsp;салатник.',
            type: 'Салаты'
        },
        {
            name: 'Колбаса жареная с капустой',
            time: 55,
            qtys: 'На&nbsp;один кочан капусты&nbsp;&mdash; 2&nbsp;моркови, 1&nbsp;головка лука, 3&nbsp;ст. ложки растительного масла.',
            foodIndex: ["Колбаса", "Капуста", "Репчатый лук", "Морковь"],
            steps: 'Овощи помыть, очистить. Морковь и&nbsp;лук нашинковать и&nbsp;обжарить с&nbsp;томатной пастой. Разогреть кастрюлю, влить немного подсолнечного масла, выложить капусту, посолить, перемешать. Затем выложить обжаренные лук и&nbsp;морковь, перемешать. Тушить на&nbsp;медленном огне примерно 40&nbsp;мин. Вареную колбасу (любительскую, отдельную, докторскую и&nbsp;др.) очистить от&nbsp;оболочки, нарезать ломтиками и&nbsp;перед подачей обжарить.',
            type: 'Горячие'
        },
        {
            name: 'Рагу из овощей с фасолью',
            time: 65,
            qtys: 'На&nbsp;1&nbsp;стакан фасоли&nbsp;&mdash; 800&nbsp;г овощей и&nbsp;картофеля, 1&nbsp;ст. ложку муки, 2&nbsp;ст. ложки масла.',
            foodIndex: ["Капуста", "Баклажаны", "Кабачки", "Картофель", "Репчатый лук", "Морковь"],
            steps: 'Очищенные, вымытые овощи нарезать крупными кубиками или дольками. Морковь и&nbsp;лук тушить, капусту и&nbsp;фасоль(предварительно вымочить ~6&nbsp;часов) отварить в&nbsp;воде, картофель обжарить на&nbsp;сковороде с&nbsp;маслом. Сделать соус из&nbsp;томатной пасты, смешав её&nbsp;с&nbsp;отваром из&nbsp;овощей. Приготовленным соусом залить овощи, сложенные в&nbsp;одну кастрюлю, добавить соль, перец, 3&ndash;4&nbsp;шт. гвоздики, кусочек корицы, накрыть кастрюлю крышкой и&nbsp;тушить 15&ndash;20&nbsp;минут. При подаче на&nbsp;стол овощи посыпать зеленью петрушки.',
            type: 'Горячие'
        }
    ];
    
        // {
        //     name: 'Солянка из рыбы на сковороде',
        //     time: 30,
        //     qtys: 'На&nbsp;500&nbsp;г рыбного филе&nbsp;&mdash; 1&nbsp;кг свежей или квашеной капусты, по&nbsp;2&nbsp;ст. ложки подсолнечного масла, томата-пюре и&nbsp;толченых сухарей, 2&nbsp;соленых огурца, 50&nbsp;г маслин, 2&nbsp;головки лука.',
        //     foodIndex: ["Рыба", "Капуста", "Соленые огурцы", "Лук", "Маслины", "Мука", "Томатная паста", "Сухари"],
        //     steps: 'Натушить для солянки свежую или квашеную капусту. Подготовленную рыбу нарезать на&nbsp;куски, сложить отдельно в&nbsp;кастрюлю, посолить, посыпать перцем, огурцы, очищенные от&nbsp;кожицы и&nbsp;зерен и&nbsp;нарезанные ломтиками, прибавить томатную пасту, лук, нашинкованный и&nbsp;слегка поджаренный с&nbsp;маслом, стакан рыбного бульона (или воды), 2&nbsp;лавровых листика, накрыть кастрюлю крышкой и&nbsp;варить 15&ndash;20&nbsp;минут. Затем прибавить муку, смешанную с&nbsp;чайной ложкой масла; осторожно, не&nbsp;ломая кусков рыбы, размешать и&nbsp;кипятить 1&ndash;2&nbsp;минуты. На&nbsp;дно сковороды положить третью часть тушеной капусты, разровнять, разложить поверх нее рыбу с&nbsp;гарниром, полить соусом, полученным при варке рыбы, покрыть остальной капустой, сравнять, посыпать толчеными сухарями, сбрызнуть маслом и&nbsp;поставить в&nbsp;духовой шкаф на&nbsp;8-10&nbsp;минут. При подаче на&nbsp;стол уложить на&nbsp;солянку вымытые маслины.',
        //     type: 'Супы'
        // },
    
        // },
        // {
        //     name: '',
        //     time: ,
        //     qtys: '',
        //     foodIndex: [],
        //     steps: '',
        //     type: ''
        // }

    
    // var recipesDb = firebase.child('recipes');
    // var _fillRecipes = function(error) {
    //     if (error) {
        
    //     } else {
    //         _.each(_recipesList, function(_el) {
    //             recipesDb.push(_el); // it's push to Firebase object, not array
    //         });
    //     }
    // };
    // recipesDb.remove(_fillRecipes);
    
    
    
    // var _foodDb = firebase.child('food');
    // var _recipesDb = firebase.child('recipes');
    
    // var _fillFood = function() {
    //     _recipesDb.once('value', function(snap) {
    //         var _recipes = snap.val();
    //         var _food = [];
            
    //         _.each(_recipes, function(_recipe_val) {
    //             _food = _.union(_food, _recipe_val.foodIndex);
    //         });
            
    //         _food = _.sortBy(_food, _.identity);
    //         _foodDb.set(_food);
    //     });
    // };
    
    // _foodDb.remove(_fillFood);
    
});

</script>
</body>
</html>

<!-- JSON.stringify -->

    <!-- todo: rename 'recipe' to 'dish' and recipe.steps to recipe-->
    <!-- todo: unify buttons a/label/button/input-->
    <!-- todo: fully switch to tabs w/o show/hide-->
    <!-- todo: convert events to 'document on' -->
    <!-- todo: classes for masses, id for unique entities -->
    
    