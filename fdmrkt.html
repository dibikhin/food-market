<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <title>
        Фдмркт Прототип
    </title>
    <!--Firebase-->
    <script src="https://cdn.firebase.com/js/client/2.2.7/firebase.js"></script>
    <!--Bootstrap-->
    <link href=
    "https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.4/css/bootstrap.min.css" rel=
    "stylesheet"><!--Bootstrap Tokenfield-->
    <link href=
    "https://cdnjs.cloudflare.com/ajax/libs/bootstrap-tokenfield/0.12.0/css/bootstrap-tokenfield.min.css"
    rel="stylesheet"><!--Tokenfield Typeahead-->
    <link href=
    "https://cdnjs.cloudflare.com/ajax/libs/bootstrap-tokenfield/0.12.0/css/tokenfield-typeahead.min.css"
    rel="stylesheet"><!--JQueryUI CSS-->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.css" rel=
    "stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
  <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
<div class="container">
    <!--<div class="row">-->
    <!--  <div class="col-md-6 col-md-offset-3">-->
    <!--    <h1>-->
    <!--      Фдмркт Прототип-->
    <!--    </h1>-->
    <!--  </div>-->
    <!--</div>-->
    
    <div class="row">
        <div class="col-md-6 col-md-offset-3">
            <!-- Tab panes -->
            
            <!--Main-->
            <div class="tab-content">
                <div style="margin-top: 20px;" role="tabpanel" class="tab-pane active" id="recipe-list">
                    <form>
                        <div class="form-group">
                            <input class="form-control" id="food-search" placeholder=
                            "Какие продукты есть?" type="text">
                        </div>
                    </form>
                    <p id="not-found-recipes">
                        Введите продукты, и здесь появятся блюда.
                    </p>
                    
                    <div id="found-recipes">
                        <!--recipe item template-->
                        <div class="recipe-item">
                            <h3>
                                <span class="recipe-name"></span>
                                <span class="label label-default recipe-time"
                                    style="float: right;">
                                    &nbsp;мин.
                                </span>
                            </h3>
                            <p>
                                <del>Простой быстрый салат</del>
                            </p>
                            <h4 style="margin-top: 20px;">
                                Не хватает
                            </h4>
                            <ul class="list-inline">
                                <li>
                                    <del>Свекла</del>
                                </li>
                                <li>
                                    <del>Морковь</del>
                                </li>
                                <li>
                                    <del>Говяжьи косточки</del>
                                </li>
                            </ul>
                            <button class="btn btn-default" type="button">
                                <span class="glyphicon glyphicon-plus"></span>
                                &nbsp;Добавить в список
                            </button>
                            <a class="btn btn-default" href="#recipe" aria-controls="recipe" role="tab" data-toggle="tab">
                                <span class="recipe-ix hidden"></span>
                                <span class="glyphicon glyphicon-eye-open"></span>
                                &nbsp;Рецепт
                            </a>
                        </div> <!--recipe template-->
                    </div>
                    
                    <a style="margin-top: 20px;" class="btn btn-default" href="#to-buy-list" aria-controls="to-buy-list" role="tab" data-toggle="tab">
                        <span class="glyphicon glyphicon-list"></span>
                        &nbsp;Список продуктов
                    </a>
                </div>  <!--recipe-list-->
                
                <!--Recipe Tab-->
                <div role="tabpanel" class="tab-pane" id="recipe">
                    <div id="recipe-body">
                        <h3>
                            Шурпа <span class="label label-default" style="float: right;">1 ч 20 мин</span>
                        </h3>
                        <ul>
                            <li>Сварить мясной бульон.</li>
                            <li>Лук нарезать в&nbsp;виде соломки и&nbsp;поджарить в&nbsp;разогретом жире.</li>
                            <li>Мясо нарезать кусочками весом 25&ndash;30&nbsp;г, обжарить, смешать с&nbsp;поджаренным луком, добавить морковь, нарезанную кубиками, томат-пюре и&nbsp;жарение продолжать в&nbsp;течение 5&ndash;6&nbsp;минут.</li>
                            <li>Подготовленное таким образом мясо вместе с&nbsp;овощами переложить в&nbsp;кастрюлю, залить бульоном и&nbsp;довести до&nbsp;кипения.</li>
                            <li>Затем положить картофель, нарезанный дольками, соль, перец и&nbsp;варить 15&ndash;20&nbsp;минут.</li>
                        </ul>
                        <p>
                            На&nbsp;500&nbsp;г говядины&nbsp;&mdash; 750&nbsp;г картофеля, 2&nbsp;головки лука, 2&nbsp;шт. моркови, по&nbsp;2&nbsp;ст. ложки томата-пюре и&nbsp;масла.
                        </p>
                        <h4 style="margin-top: 20px;">
                            Не хватает
                        </h4>
                        <ul class="list-inline">
                            <li>Говяжьи косточки</li>
                            <li>Морковь</li>
                            <li>Свекла</li>
                        </ul>
                        
                        <a class="btn btn-default" href="#to-buy-list" aria-controls="to-buy-list" role="tab" data-toggle="tab">
                            <span class="glyphicon glyphicon-plus"></span>
                            &nbsp;Добавить в список
                        </a>
                    </div>
                    
                    <!--Nav-->
                    <a class="btn btn-default" href="#recipe-list" aria-controls="recipe-list" role="tab" data-toggle="tab"
                        style="margin-top: 10px;">
                        <span class="glyphicon glyphicon-arrow-left"></span>
                        &nbsp;Назад
                    </a>
                </div> <!--recipe-body-->
                
                <!--To Buy Tab-->
                <div role="tabpanel" class="tab-pane" id="to-buy-list">
                    <div id="to-buy-list-body">
                        <h3>
                            Купить
                            <!--<button class="btn btn-default" type="button">Отправить</button>-->
                        </h3>
                        
                        <!--to-buy-search-->
                        <!--todo rename 'addToList*'-->
                        <form class="form-inline addToListForm">
                            <div class="form-group">
                                <input id="to-buy-search" type="text" name="listItemInput" class="form-control listItemInput" placeholder="Что купить?">
                            </div>
                            <button type="button" class="btn btn-default addToList">
                                <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
                                    &nbsp;Добавить
                            </button>
                            <label type="button" class="btn btn-default" id="clear-to-buy-food-list">
                                <span class="glyphicon glyphicon-erase" aria-hidden="true"></span>
                                    &nbsp;Очистить
                            </label>
                        </form>
                        
                        <div class="to-buy-food-list">
                            
                        </div>
                    </div>
                    
                    <a class="btn btn-default" href="#recipe" aria-controls="recipe" role="tab" data-toggle="tab"
                        style="margin-top: 10px;">
                        <span class="glyphicon glyphicon-arrow-left"></span>
                        &nbsp;Назад
                    </a>
                </div> <!--to-buy-list-->
            </div> <!--tab-content-->
        </div> <!--col-->
    </div> <!--row-->
    
    <!--empty-->
    <div class="row">
        <div class="col-md-6 col-md-offset-3">
            
        </div> <!--col-->
    </div> <!--row-->
    
</div>  <!--container-->

<!--jQuery-->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
<!--jQueryUI-->
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-tokenfield/0.12.0/bootstrap-tokenfield.min.js"></script>
<!--Underscore-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
<!--PureJS--> <!--Yandex.Browser claims security issue-->
<!--<script src="https://raw.github.com/pure/pure/master/libs/pure.js"></script>-->
<script src="pure.min.js"></script>

<script>
    //// init autocompletes
    var firebase = new Firebase("https://foodmarket.firebaseio.com/");
    firebase.child('food').once('value', function(snapshot) {
        $('#food-search').tokenfield({
            autocomplete: {
                source: snapshot.val(), // it's not live
                delay: 100
            }
        });
        
        // note: relies on name
        $('#food-search-tokenfield').focus();
        
        $('#to-buy-search').autocomplete({
            source: snapshot.val(), // it's not live too
        });        
    });
    
    //// template engine
    var directive1 = {
            '.recipe-item': {
                'recipe<-': {
                    '.recipe-ix': 'recipe.ix',
                    '.recipe-name': 'recipe.name',
                    '+.recipe-time': 'recipe.time' // note '+'
                }
            }
        };
    
    // compile is of PureJS
    var compiledDirective = $('#found-recipes').compile(directive1);
    
    //// cosmetics
    $('#found-recipes').hide();
    
    //// food-search logic
    
    var foundRecipes = [];
    
    var findFood = function() {
        
        $('#not-found-recipes').show();
        $('#found-recipes').hide();
        
        var chosenFood = null;
        var chosenFoodStr = $('#food-search').tokenfield('getTokensList', ' ');
        if (chosenFoodStr !== '') {
            chosenFood = chosenFoodStr.split(' ');
        } else { 
            return;
        }
        
        var recipes = null;
        firebase.child('recipes').once('value', function(snapshot) {
            recipes = snapshot.val();
            
            // todo underscore it!
            // find foods in recipes
            $.each(chosenFood, function(__, fd) {
                $.each(recipes, function(ix_rcp, rcp) {
                	var found = rcp.steps.search(new RegExp(fd + '.', 'i'));
                    if (found !== -1) {
                        rcp.ix = ix_rcp;
                        foundRecipes.push(rcp);
                    }
                });
            });
            
            if(_.any(foundRecipes)) {
                $('#found-recipes').render(foundRecipes, compiledDirective);
                $('#not-found-recipes').hide();
                $('#found-recipes').show();
            }
        });
    };
    
    //// Main loop, tokenfield events
    $('#food-search').on('tokenfield:createdtoken', findFood);
    // $('#food-search').on('tokenfield:editedtoken', findFood); // blinks
    $('#food-search').on('tokenfield:removedtoken', findFood);
    
    
    //// recipe view
    $(document).on('click', '#recipe', function() {
        var recipeIx = $(this).find('.recipe-ix').val();
        var curRecipe = _.find(foundRecipes, function(_rcp) {
            return _rcp.ix === recipeIx;
        });
        // todo render recipe
        // todo fill recipe on click
        // todo show recipe on click
    });
    
    //// to-buy-food-list
    var addToList = function() {
        var itemToAdd = $('input[name="listItemInput"]').val().trim();
        if(itemToAdd) {
            $('.to-buy-food-list').append(
                '<div class="checkbox"><label><input type="checkbox" value="' 
                + itemToAdd + '">'+ itemToAdd +'</label></div>');
        }
        $('.listItemInput').val('').focus();
    };
    
    $(document).on('click', '.addToList', addToList);
    
    $(document).on('click', '#clear-to-buy-food-list', function() {
        $('.to-buy-food-list').html('');
    });
    
    $('.listItemInput').keypress(function(e) {
        if (e.which == 13) {
            addToList();
            e.preventDefault();        
            return false;
        }
    });
    
    
    //// fill DB
    
    // var recipes1234 = firebase.child('recipes');
    //  var recipe5645 = [
    //      {
    //         name: 'Салат со сметаной и яйцом',
    //         time: 15,
    //         qtys: 'На&nbsp;300&nbsp;г зеленого салата&nbsp;&mdash; 1&nbsp;свежий огурец, 1&nbsp;яйцо, 1/2 стакана соуса из&nbsp;сметаны с&nbsp;уксусом.',
    //         foodIndex: 'зеленый салат, огурец, огурцы, яйцо, яйца, сметана, уксус',
    //         steps: 'Обмытый и&nbsp;отсушенный зеленый салат нарезать и&nbsp;сложить в&nbsp;миску. Яйца, сваренные вкрутую, нарезать тонкими ломтиками и&nbsp;смешать с&nbsp;соусом из&nbsp;сметаны с&nbsp;уксусом. Перед самой подачей к&nbsp;столу заправить салат сметанным соусом с&nbsp;яйцом, уложить в&nbsp;салатник, обложить кружочками свежих огурцов и&nbsp;посыпать мелко нарезанным укропом или зеленью петрушки. Подается салат ко&nbsp;всем мясным и&nbsp;рыбным блюдам.'
    //      }
    // ];
    // recipes1234.set(recipe5645);
    
</script>
</body>
</html>

<!--JSON.stringify-->
